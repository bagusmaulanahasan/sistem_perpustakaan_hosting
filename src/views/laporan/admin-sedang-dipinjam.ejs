<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <title>Laporan Buku Sedang Dipinjam</title>
        <style>
            body {
                font-family: "Helvetica", "Arial", sans-serif;
                font-size: 11px;
                color: #333;
            }
            .container {
                width: 100%;
                margin: 0 auto;
                padding: 25px;
            }
            .header {
                text-align: center;
                border-bottom: 1px solid #ddd;
                padding-bottom: 15px;
                margin-bottom: 30px;
            }
            .header h1 {
                margin: 0;
                font-size: 22px;
            }
            .header p {
                margin: 5px 0 0;
                font-size: 14px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th,
            td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            thead {
                background-color: #f2f2f2;
            }
            .no-data {
                text-align: center;
                padding: 20px;
                font-style: italic;
            }
            /* Styling untuk Status */
            .text-red { color: #dc2626; font-weight: bold; }
            .text-yellow { color: #d97706; font-weight: bold; }
            .text-green { color: #16a34a; font-weight: bold; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Laporan Buku Sedang Dipinjam</h1>
                <p>
                    Diunduh pada: <%= new Date().toLocaleDateString('id-ID', {
                    day: '2-digit', month: 'long', year: 'numeric' }) %>
                </p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 5%">No.</th>
                        <th style="width: 20%">Nama Peminjam</th>
                        <th style="width: 30%">Judul Buku</th>
                        <th style="width: 15%">Tanggal Pinjam</th>
                        <th style="width: 15%">Batas Kembali</th>
                        <th style="width: 15%">Status</th> </tr>
                </thead>
                <tbody>
                    <% if(borrowings.length > 0) { %> 
                    
                    <% borrowings.forEach((item, index) => { %>
                        <% 
                            // --- LOGIKA HITUNG HARI (Sama seperti di Website) ---
                            const dueDate = new Date(item.due_date);
                            const today = new Date();
                            
                            // Reset jam agar hitungan murni tanggal
                            dueDate.setHours(0, 0, 0, 0);
                            today.setHours(0, 0, 0, 0);
                            
                            // Hitung selisih waktu (DueDate - Hari Ini)
                            const diffTime = dueDate.getTime() - today.getTime();
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            let statusText = '';
                            let statusClass = '';

                            if (diffDays < 0) {
                                // Jika minus, berarti sudah lewat tanggal (Terlambat)
                                statusText = `Terlambat ${Math.abs(diffDays)} hari`;
                                statusClass = 'text-red';
                            } else if (diffDays <= 3) {
                                // Warning jika sisa 3 hari atau kurang
                                statusText = `Sisa ${diffDays} hari`;
                                statusClass = 'text-yellow';
                            } else {
                                // Masih aman
                                statusText = `Sisa ${diffDays} hari`;
                                statusClass = 'text-green';
                            }
                        %>
                    <tr>
                        <td style="text-align: center;"><%= index + 1 %></td>
                        <td>
                            <%= item.username %><br/>
                            <small style="color: #666;"><%= item.email %></small>
                        </td>
                        <td><%= item.title %></td>
                        <td>
                            <%= new Date(item.borrow_date).toLocaleDateString('id-ID') %>
                        </td>
                        <td>
                            <%= new Date(item.due_date).toLocaleDateString('id-ID') %>
                        </td>
                        <td class="<%= statusClass %>">
                            <%= statusText %>
                        </td>
                    </tr>
                    <% }) %> 
                    
                    <% } else { %>
                    <tr>
                        <td colspan="6" class="no-data">
                            Tidak ada buku yang sedang dipinjam saat ini.
                        </td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </body>
</html>